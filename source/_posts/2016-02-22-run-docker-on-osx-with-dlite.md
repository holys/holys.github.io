title: Simplifying Docker on OS X With Dlite
date: 2016-02-22 22:58:21
tags:
- docker
- dlite
---


*å‰æ–¹é«˜èƒ½æé†’*ï¼šå¦‚æžœä½ çš„ç³»ç»Ÿå°äºŽ OS X Yosemite (10.10.3)ï¼Œä¸”ä¸å‡†å¤‡å‡çº§åˆ°ç¬¦åˆæ¡ä»¶çš„ç‰ˆæœ¬ï¼Œå°±ä¸ç”¨å¾€ä¸‹çœ‹äº†ã€‚

## Dlite æ˜¯ä»€ä¹ˆï¼Ÿ

æ—©åœ¨2013å¹´åº•ï¼Œç¬”è€…å®žä¹ çš„æ—¶å€™å°±å¼€å§‹çŽ© dockerï¼Œåªæ˜¯é‚£æ—¶ docker è¿˜æ˜¯ dotCloud(çŽ°å·²å–æŽ‰ï¼Œæ”¹åä¸º Docker.Inc)å‘˜å·¥çš„ä¸šä½™é¡¹ç›®ï¼Œè¿˜å¾ˆä¸æˆç†Ÿã€‚è½¬çœ¼é—´åˆ°äº†2016å¹´ï¼Œåˆå‡†å¤‡é‡æ–°æ¡èµ·æ¥ã€‚

ä½¿ç”¨ Mac OSX ç³»ç»Ÿçš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“ï¼Œdocker æ˜¯æ²¡æœ‰åŽŸç”Ÿæ”¯æŒ OS X ç³»ç»Ÿçš„ï¼Œè¦ä¹ˆé€šè¿‡ [boot2docker](https://github.com/boot2docker/boot2docker), è¦ä¹ˆé€šè¿‡ [docker-machine](https://docs.docker.com/machine/)ï¼Œ äºŒè€…æœ‰ä¸ªå…±åŒç‚¹ï¼šä¾èµ– VMï¼ˆå¦‚ virtualboxï¼‰æ¥è¿è¡Œä¸€ä¸ª linux è™šæ‹Ÿæœºï¼Œ ç„¶åŽè™šæ‹Ÿæœºè·‘ç€ docker daemonã€‚ç„¶è€Œ virtualbox å¹¶ä¸æ˜¯ä¸ªè½»é‡çº§çš„è™šæ‹ŸåŒ–æ–¹æ¡ˆï¼Œå¯¹äºŽæˆ‘è¿™ç§ä½¿ç”¨ä¹žä¸ç‰ˆ MBPçš„äººæ¥è¯´ï¼Œä¸å¤ªæ–¹ä¾¿ã€‚ç”¨ç€15å¯¸é«˜é… Macbook Pro çš„åœŸè±ªè¯·éšæ„ :)

ä»Šå¤©æˆ‘ä»¬è¦ä»‹ç»çš„ä¸»è§’æ˜¯ï¼š[Dlite](https://github.com/nlf/dlite)ã€‚Dlite æ˜¯ä»€ä¹ˆå‘¢? è¿™é‡Œç›´æŽ¥å¼•ç”¨ Dlite é¡¹ç›®æ–‡æ¡£çš„ä»‹ç»ï¼š

> DLite leverages xhyve through the libxhyve Go bindings for virtualization.

å¤§æ„æ˜¯ï¼š å¾—ç›ŠäºŽ [xhyve](https://github.com/mist64/xhyve) å’ŒåŸºäºŽgoå°è£…åŽçš„ [libxhyve](https://github.com/TheNewNormal/libxhyve) ä¸¤ä¸ªé¡¹ç›®æ‰æœ‰äº† Dlite çš„è¯žç”Ÿï¼ˆå¦¹å­å¸®æˆ‘è¯‘çš„ ðŸ˜„ï¼‰ã€‚

xhyve, æ˜¯ OSX ä¸‹ä¸€ç§è½»é‡çº§çš„è™šæ‹ŸåŒ–è§£å†³æ–¹æ¡ˆï¼Œå»ºç«‹åœ¨ OSX 10.10 Yosemite çš„ Hypervisor.framework ä¹‹ä¸Šï¼Œå®Œå…¨è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´å†…ï¼Œæ²¡æœ‰å…¶ä»–ä»»ä½•ä¾èµ–ã€‚å®ƒå¯ä»¥è¿è¡Œ FreeBSD ç³»ç»Ÿå’Œ ä½¿ç”¨ Linux å†…æ ¸çš„å‘è¡Œç‰ˆã€‚å…¶å®ž xhyve æ˜¯ bhyve çš„ OS X ç§»æ¤ç‰ˆæœ¬ã€‚è€Œbhyve ï¼Œå³ BSD hypervisorï¼Œæ˜¯åœ¨ FreeBSD ä¸Šå¼€å‘çš„è™šæ‹Ÿæœºç®¡ç†å™¨ï¼ˆhypervisor/virtual machine managerï¼‰ã€‚

é‚£ä¹ˆ Dlite æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ èªæ˜Žçš„è¯»è€…åº”è¯¥æƒ³åˆ°ï¼šæ—¢ç„¶æœ‰äº†xhyve è¿™ä¸ªè™šæ‹ŸåŒ–è§£å†³æ–¹æ¡ˆï¼Œè‚¯å®šè¿˜å¾—éœ€è¦ä¸€ä¸ª linux è™šæ‹Ÿæœºæ¥è¿è¡Œ dockerã€‚è¿™ä¸ª linux å‘è¡Œç‰ˆæ˜¯ DhyveOS, æ˜¯ Dlite ä½œè€…ä¸ºäº†æ­¤é¡¹ç›®åˆ›å»ºçš„ä¸€ä¸ªè¶…è½»é‡çº§ Linux OSï¼š[DhyveOS](https://github.com/nlf/dhyve-os)ã€‚ 

å³ `Dlite = xhyve + DhyveOS`

Dlite é€šè¿‡ libxhyve æ¥è°ƒç”¨xhyveï¼Œç„¶åŽxhyveè¿è¡Œç€ DhyveOSï¼Œ DhyveOS è¿è¡Œç€ dockerã€‚ å¯¹äºŽ Mac ç”¨æˆ·æ¥è¯´ï¼Œåªéœ€è¦å®‰è£… Dliteï¼Œå°±å¯ä»¥æ‹¥æœ‰ dockerã€‚

 
## å¦‚ä½•å®‰è£… Dlite

æœ‰ä¸‰ç§æ–¹å¼å®‰è£…Dliteï¼š
1. åœ¨ Dlite çš„ Release é¡µé¢ç›´æŽ¥ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶ï¼›
2. é€šè¿‡ Homebrew å®‰è£…ï¼šbrew install dlite3. 
3. å› ä¸º Dlite æ˜¯ Go å†™çš„ï¼Œå¯ä»¥ç›´æŽ¥ go get github.com/nlf/dliteï¼Œ ç„¶åŽ make dlite 

å…¶ä½œè€…æŽ¨èä½¿ç”¨ homebrew æ–¹å¼å®‰è£… Dliteã€‚

## å¦‚ä½•ä½¿ç”¨ Dlite

åªéœ€è¦è¿è¡Œ sudo dlite installï¼Œ dlite ä¼šè‡ªåŠ¨å¸®ä½ åˆ›å»ºéœ€è¦çš„æ–‡ä»¶ï¼Œç„¶åŽå¯åŠ¨ä¸€ä¸ª agent æ¥ç®¡ç†è¿™ä¸ªè¿›ç¨‹ã€‚

ä½ å¯ä»¥é€šè¿‡ sudo dlite install --help æ¥æŸ¥çœ‹å…¶å®ƒé€‰é¡¹ï¼Œå¦‚æŒ‡å®šCPU çš„ä¸ªæ•°ï¼Œç£ç›˜å¤§å°ï¼Œå†…å­˜ç­‰ç­‰ã€‚

å…¶å®ž install è¿™ä¸ªè¿‡ç¨‹åšäº†å››ä»¶äº‹æƒ…ï¼š

1. åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„ç©ºæ–‡ä»¶ `disk.img`ï¼ˆé»˜è®¤æ˜¯20GBï¼‰æ¥ä½œä¸ºDhyveOSè™šæ‹Ÿæœºçš„ç£ç›˜ç©ºé—´ï¼›
2. ä¸‹è½½æž„å»ºDhyveOS æ‰€éœ€çš„ä¸¤ä¸ªæ–‡ä»¶ï¼Œ `bzImage` å’Œ `rootfs.cpio.xz`ï¼ˆDhyveOS çš„ release é¡µé¢æä¾›äº†è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼‰
3. åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œå¦‚æ²¡æœ‰æŒ‡å®šåˆ™ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œ
æ ·ä¾‹ï¼š

    ```
    {"uuid":"d93a1a37-d47c-11e5-92af-60f81da97a72","cpu_count":1,"memory":2,"hostname":"local.docker","share":"/Users"}%
    ```

4. åˆ›å»º launchd agent

ä¸Šè¿°æ“ä½œåˆ›å»ºçš„æ–‡ä»¶éƒ½å¯ä»¥åœ¨ `~/.dlite`ç›®å½•æ‰¾åˆ°ã€‚


å¯åŠ¨/å…³é—­ DhyveOSï¼ˆå½“ç„¶ä¹ŸåŒ…æ‹¬å¯åŠ¨/å…³é—­äº† docker æœåŠ¡ï¼‰åªåˆ†åˆ«éœ€è¦æ‰§è¡Œï¼š

    dlite start 
    dlite stop

å³å¯ã€‚

å¯åŠ¨ DhyveOS åŽå°±å¯ä»¥ä½¿ç”¨ Docker æœåŠ¡å•¦ã€‚å¦‚æžœéœ€è¦ SSH ç™»å½•åˆ°è™šæ‹Ÿæœºé‡Œé¢ï¼Œå¯ä»¥ `ssh docker@local.docker` ã€‚ Dlite ä¼šè‡ªåŠ¨æ·»åŠ  `local.docker` åˆ° OS X çš„ hosts æ–‡ä»¶å†…ã€‚å¦‚æžœæ²¡æœ‰æ‰¾åˆ°è¯¥è®°å½•ï¼Œåº”è¯¥é€šè¿‡ IP æ–¹å¼æ¥ç™»å½•ï¼Œ è¿è¡Œ dlite ip å¯ä»¥èŽ·å–è™šæ‹Ÿæœºçš„ IPã€‚

å…³äºŽDhyveOS ä½ éœ€è¦çŸ¥é“çš„æ˜¯ï¼š

1. /Users ç›®å½•ä¼šè‡ªåŠ¨æŒ‚è½½åˆ°è™šæ‹Ÿæœºä¸Š
2. root ç”¨æˆ·çš„ç¼ºçœå¯†ç æ˜¯ï¼š dhyve
3. docker ç”¨æˆ·çš„ç¼ºçœå¯†ç æ˜¯ï¼š docker
4. dlite ä¼šé»˜è®¤å°† $HOME/.ssh/id_rsa.pub å¤åˆ¶åˆ°DhyveOSï¼ŒSSH ç™»å½•å…å¯†ç ã€‚

å¦‚æžœéœ€è¦æ›´æ–° VM, åªéœ€è¦æ‰§è¡Œä¸‹è¿°å‘½ä»¤ï¼ˆä¸ä¼šé‡æ–°æž„å»ºç³»ç»Ÿï¼‰ï¼š

    dlite stop
    dlite update
    dlite start
    
    
ç”±äºŽdocker æ˜¯ä¸ª C/S æ¨¡åž‹çš„åº”ç”¨ï¼Œå¯ä»¥ç›´æŽ¥åœ¨ OS X è¿™ä¸€å±‚æ¥ä½¿ç”¨ docker å®¢æˆ·ç«¯ï¼Œå°±ä¸ç”¨ç™»å½•åˆ° DhyveOS é‡Œé¢å†ä½¿ç”¨ docker è¿™ä¹ˆéº»çƒ¦å•¦ï¼Œå‰ææ˜¯ä½ å·²ç»åœ¨ OS X ç³»ç»Ÿå®‰è£…äº† docker å®¢æˆ·ç«¯ï¼ˆæ³¨: docker çš„ client å’Œ server éƒ½åœ¨åŒä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å†…ï¼‰ã€‚

## Dlite çš„ä¸è¶³

ç”±äºŽ Dlite æ˜¯å»ºç«‹åœ¨ xhyve ä¹‹ä¸Šï¼Œå…¶ä¸è¶³ä¹Ÿä¼šä¸Ž dlite ç›¸éšã€‚
å³ OS Xç³»ç»Ÿç‰ˆæœ¬éœ€è¦åœ¨ `10.10.3` ä»¥ä¸Šï¼Œè¿˜éœ€è¦æ¯”è¾ƒæ–°çš„é…ç½®ï¼ˆéœ€è¦æ˜¯è¿‘å‡ å¹´çš„ Mac ç¡¬ä»¶ï¼Œé»‘è‹¹æžœä¼°è®¡ä¸è¡Œå§ï¼‰ã€‚å¯ä»¥é€šè¿‡ `sysctl kern.hv_support` æ¥ç¡®è®¤æ˜¯å¦æ»¡è¶³è¦æ±‚ã€‚å¦‚æžœçœ‹åˆ° `kern.hv_support: 1` è¿”å›žï¼Œé‚£å°±æ˜¯æ»¡è¶³å’¯ã€‚

## å…¶ä»–

å¦‚æžœä½ éœ€è¦ç»™ docker é…ç½®åŠ é€Ÿå™¨ï¼ˆèµµå›½çš„ç½‘ç»œä½ æ‡‚çš„ï¼‰ï¼Œä½ éœ€è¦çŸ¥é“ dlite ä¸‹çš„docker æœåŠ¡æ˜¯å¦‚ä½•å¯åŠ¨çš„ã€‚docker å¯åŠ¨å‚æ•°ä½äºŽ DhyveOS è™šæ‹Ÿæœºç³»ç»Ÿçš„ `/etc/default/docker`

```
docker@dlite:~$ cat /etc/default/docker
DOCKER_ARGS="-H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375 -s btrfs --registry-mirror=http://yours.m.daocloud.io"
```


## æ€»ç»“
åˆšæŽ¥è§¦ dlite ä¸ä¹…ï¼Œæš‚æ—¶è¿˜æ²¡é‡åˆ°ä»€ä¹ˆå¤§å‘ï¼Œç”¨èµ·æ¥è¿˜æ˜¯è›®æ–¹ä¾¿çš„ï¼Œå€¼å¾—æŽ¨èï¼å¦‚æžœè¯»è€…åœ¨ä½¿ç”¨è¿‡ç¨‹é‡åˆ°é—®é¢˜ï¼Œæ¬¢è¿Žç•™è¨€æŽ¢è®¨ï¼Œå…±åŒå­¦ä¹ æé«˜ ðŸ˜„


## æ›´æ–°
2016.02.24 
ä»Šå¤©æ—©ä¸Šæ‰“å¼€ç”µè„‘ï¼Œå‘çŽ°èŽ«åå¥‡å¦™å…³æœºäº†ï¼Œå¾—å¼ºåˆ¶é‡å¯ã€‚è”æƒ³èµ·å‰å‡ å¤©ä¹Ÿé‡åˆ°è¿™ç§é—®é¢˜ï¼Œä¹Ÿæ˜¯è¿™ä¹ˆå¤„ç†ã€‚æ€€ç–‘æ˜¯ Dlite é—®é¢˜ï¼ŒåŽ» Dlite çš„ issues æœç´¢å‘çŽ°æœ‰[ç±»ä¼¼æƒ…å†µ](https://github.com/nlf/dlite/issues/60), ä½†æ˜¯ä½œè€…è¯´è¿™æ˜¯ xhyve çš„é—®é¢˜ï¼Œç„¶åŽåŽ» xhyve çš„ issue æœç´¢ï¼Œå‘çŽ°çœŸæœ‰[è¿™ç§é—®é¢˜](https://github.com/mist64/xhyve/issues/86)ï¼Œè€Œä¸”ä¸å°‘äººé‡åˆ°ã€‚æš‚æ—¶æ²¡çœ‹åˆ°è§£å†³åŠžæ³•ã€‚è‡ªå·±å†³å®šç”¨ä¸ç”¨å§ã€‚ä¸ªäººè§‰å¾—æ˜¯ç”µè„‘ä¼‘çœ æ‰ä¼šé‡åˆ°è¿™ç§é—®é¢˜ï¼Œä½†æ˜¯ MacBook ä¸åˆä¸Šæ€Žä¹ˆå¸¦å›žå®¶å‘€ï¼Ÿå¯èƒ½æ¯å¤©æ™šä¸Šç¡è§‰å‰æŠŠ Dlite è¿›ç¨‹å…³é—­ï¼Œä¸å¤±ä¸ºä¸€ä¸ªæŠ˜ä¸­çš„åŠžæ³• ðŸ˜„


2017.01.07

æœ€è¿‘å¾—çŸ¥ï¼Œdocker å®˜æ–¹å·²ç»å¼€å§‹ä½¿ç”¨ HyperKit ä½œä¸º macOS åŽŸç”Ÿè™šæ‹Ÿè§£å†³æ–¹æ¡ˆï¼Œå’Œ dlite åº”è¯¥æ˜¯åŒä¸€ä¸ªå¥—è·¯ï¼Œä½†æ˜¯æœ‰docker å®˜æ–¹çš„æ”¯æŒï¼Œä½¿ç”¨èµ·æ¥åº”è¯¥ä¼šæ›´èˆ’æœï¼ŒæŽ¨èè¿™ä¸ªæ–¹æ¡ˆã€‚

> Docker for Mac does not use VirtualBox, but rather HyperKit, a lightweight macOS virtualization solution built on top of Hypervisor.framework in macOS 10.10 Yosemite and higher.
> https://docs.docker.com/docker-for-mac/docker-toolbox/

references:
1. [Simplifying Docker on OS X](https://blog.andyet.com/2016/01/25/easy-docker-on-osx/)











